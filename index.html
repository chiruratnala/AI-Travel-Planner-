<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2306b6d4%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/><polygon points=%2216.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76%22 fill=%22%2306b6d4%22/></svg>">        
    <meta name="google-signin-client_id" content="945126500147-nj621u8rpo487apfp39m4hq7olau2j8g.apps.googleusercontent.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .loader-text {
            animation: fadeInOut 2s ease-in-out infinite;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .error-message {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .error-message.show {
            display: block;
            opacity: 1;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #toast {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .leaflet-control-attribution a {
            color: #0891b2 !important;
        }
        .custom-map-icon svg {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }
        .draggable {
            cursor: grab;
        }
        .draggable:active {
            cursor: grabbing;
        }
        .sortable-ghost {
             opacity: 0.4;
             background-color: #f0f9ff;
             border: 2px dashed #06b6d4;
        }
        .sortable-drag {
            opacity: 0.9;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="min-h-screen flex flex-col">

        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-2 min-w-0">
                        <i data-lucide="compass" class="h-8 w-8 text-cyan-500 flex-shrink-0"></i>
                        <span class="text-xl sm:text-2xl font-bold text-slate-800 truncate">
                            <span class="hidden sm:inline">Travel Planner </span>
                        </span>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div id="g_id_onload" 
                             data-client_id="945126500147-nj621u8rpo487apfp39m4hq7olau2j8g.apps.googleusercontent.com"
                             data-callback="handleGoogleSignIn"
                             data-auto_prompt="false">
                        </div>
                        <div id="auth-container-buttons" class="flex items-center space-x-2 sm:space-x-4">
                            </div>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-grow">
            <section id="heroSection" class="container mx-auto px-4 py-16 sm:py-24 text-center">
                <div class="max-w-3xl mx-auto">
                    <span class="inline-block px-4 py-1.5 mb-4 text-sm font-semibold text-cyan-700 bg-cyan-100 rounded-full">AI-Powered Travel Planning</span>
                    <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold tracking-tight text-slate-900">Smarter travel, student budgets.</h1>
                    <p class="mt-6 max-w-2xl mx-auto text-lg text-slate-600">Stop stressing over spreadsheets. Tell us your destination and budget, and our AI will craft a personalized itinerary with all the must-see spotsâ€”in seconds.</p>
                    <div class="mt-8 flex items-center justify-center">
                        <button id="startPlanningBtn" class="w-full sm:w-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
                            <span class="flex items-center justify-center space-x-2">
                                <i data-lucide="wand-2"></i>
                                <span>Plan a New Trip</span>
                            </span>
                        </button>
                    </div>
                </div>
            </section>

            <section id="planningSection" class="hidden container mx-auto px-4 py-12">
                <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-200">
                    <div class="p-6 sm:p-8">
                        <div id="errorMessage" class="error-message mb-4 p-4 bg-red-100 border border-red-200 text-red-700 rounded-lg">
                            <p class="font-bold">Oops! Something went wrong.</p>
                            <p id="errorText" class="text-sm">Could not generate the itinerary. Please try again.</p>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-center text-slate-800">Tell us about your trip!</h2>
                            <p class="text-center text-slate-500 mt-1">Our AI will find the best spots for you.</p>
                            <div class="space-y-6 mt-8">
                                <div>
                                    <label for="destination" class="block text-sm font-medium text-slate-700">Destination (City, Country)</label>
                                    <div class="mt-1 relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="map-pin" class="h-5 w-5 text-slate-400"></i>
                                        </div>
                                        <input type="text" id="destination" class="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., Mumbai, India">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div>
                                        <label for="startDate" class="block text-sm font-medium text-slate-700">Start Date</label>
                                        <input type="date" id="startDate" class="mt-1 w-full py-2 px-3 border border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500">
                                    </div>
                                    <div>
                                        <label for="endDate" class="block text-sm font-medium text-slate-700">End Date</label>
                                        <input type="date" id="endDate" class="mt-1 w-full py-2 px-3 border border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div>
                                        <label for="travelers" class="block text-sm font-medium text-slate-700">Travelers</label>
                                        <div class="mt-1 relative">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i data-lucide="users" class="h-5 w-5 text-slate-400"></i>
                                            </div>
                                            <input type="number" id="travelers" class="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., 2">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="budget" class="block text-sm font-medium text-slate-700">Total Budget (INR)</label>
                                        <div class="mt-1 relative">
                                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                 <i data-lucide="indian-rupee" class="h-5 w-5 text-slate-400"></i>
                                             </div>
                                             <input type="number" id="budget" class="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., 50000">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8">
                                <button id="generateBtn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg shadow hover:shadow-md transition-all flex items-center justify-center space-x-2">
                                    <i data-lucide="sparkles"></i>
                                    <span>Generate Itinerary</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="loadingSection" class="hidden text-center py-24">
                <div class="flex flex-col items-center justify-center">
                    <div class="relative h-16 w-16">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-cyan-500"></div>
                        <i data-lucide="compass" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-8 w-8 text-cyan-500"></i>
                    </div>
                    <p class="mt-6 text-lg font-semibold text-slate-700">Crafting your perfect adventure...</p>
                    <p id="loaderText" class="loader-text mt-2 text-slate-500">Packing your digital bags...</p>
                </div>
            </section>
            
            <section id="itinerarySection" class="hidden container mx-auto px-4 py-12">
                 <div class="text-center mb-8">
                    <p id="trip-location" class="text-3xl sm:text-4xl font-extrabold tracking-tight text-slate-900"></p>
                    <p id="trip-dates" class="mt-2 text-slate-600"></p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-3">
                        <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200 mb-6">
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="font-bold text-slate-800">Budget Overview</h3>
                                <p class="text-sm font-medium text-slate-500">
                                    <span id="estimated-cost" class="text-slate-800 font-bold"></span> / <span id="total-budget"></span>
                                </p>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div id="budget-bar" class="bg-cyan-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-slate-500 text-right mt-1">Total Estimated Spending</p>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <i data-lucide="bed-double" class="h-6 w-6 mx-auto text-cyan-600 mb-1"></i>
                                <p class="text-xs text-slate-500">Accommodation</p>
                                <p id="budget-accommodation" class="font-bold text-slate-800"></p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <i data-lucide="utensils-crossed" class="h-6 w-6 mx-auto text-cyan-600 mb-1"></i>
                                <p class="text-xs text-slate-500">Food</p>
                                <p id="budget-food" class="font-bold text-slate-800"></p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <i data-lucide="ticket" class="h-6 w-6 mx-auto text-cyan-600 mb-1"></i>
                                <p class="text-xs text-slate-500">Activities</p>
                                <p id="budget-activities" class="font-bold text-slate-800"></p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <i data-lucide="bus" class="h-6 w-6 mx-auto text-cyan-600 mb-1"></i>
                                <p class="text-xs text-slate-500">Local Travel</p>
                                <p id="budget-travel" class="font-bold text-slate-800"></p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <i data-lucide="shopping-cart" class="h-6 w-6 mx-auto text-cyan-600 mb-1"></i>
                                <p class="text-xs text-slate-500">Misc/Buffer</p>
                                <p id="budget-misc" class="font-bold text-slate-800"></p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200 mb-6 text-center">
                            <button id="estimateTravelCostBtn" class="w-full sm:w-auto bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 mx-auto">
                                <i data-lucide="plane"></i>
                                <span>Estimate Travel Cost to Destination</span>
                            </button>
                            <div id="travelCostResult" class="mt-3 text-slate-600 text-sm"></div>
                        </div>
                        <div id="budget-note" class="bg-cyan-50 border border-cyan-200 text-cyan-800 p-4 rounded-lg mb-8 flex items-start gap-3">
                            <i data-lucide="info" class="h-5 w-5 flex-shrink-0 mt-0.5"></i>
                            <div>
                                <h4 class="font-bold">Plan Your Spendings</h4>
                                <p class="text-sm">This is an AI-generated budget estimate. Spend your money based on your budget!</p>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i data-lucide="calendar-days"></i>
                                Your Plan
                            </h3>
                            <div id="itinerary-content-container" class="space-y-8"></div>
                        </div>
                        <div class="mt-10">
                             <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                 <i data-lucide="sparkles"></i>
                                 Recommendations
                             </h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                 <div>
                                     <h4 class="text-lg font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                         <i data-lucide="bed-double"></i>
                                         Accommodation
                                     </h4>
                                     <div id="hotel-cards" class="space-y-3"></div>
                                 </div>
                                 <div>
                                     <h4 class="text-lg font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                         <i data-lucide="utensils-crossed"></i>
                                         Foodie Finds
                                     </h4>
                                     <div id="restaurant-cards" class="space-y-3"></div>
                                 </div>
                             </div>
                        </div>
                    </div>
                     <div class="lg:col-span-2">
                        <div class="sticky top-24 h-[80vh] rounded-xl shadow-lg border border-slate-200 bg-slate-100 flex items-center justify-center">
                            <div id="map" class="h-full w-full rounded-xl"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-12 text-center flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="startOverBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg transition-all">
                        <i data-lucide="rotate-ccw"></i>
                        Start Over
                    </button>
                    <button id="saveTripBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:shadow-md transition-all">
                        <i data-lucide="download"></i>
                        <span>Save to My Trips</span>
                    </button>
                </div>
            </section>
        </main>

        <footer class="bg-slate-100 border-t border-slate-200">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-sm text-slate-500">
                <p>&copy; 2025 Travel Planner. All rights reserved.</p>
                <p class="mt-1">Making student travel easier, one trip at a time.</p>
            </div>
        </footer>
    </div>

    <div id="modals-container">
        <div id="myTripsModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 modal-backdrop opacity-0">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col modal-content scale-95 opacity-0">
                <div class="flex justify-between items-center p-4 border-b border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i data-lucide="briefcase" class="text-cyan-500"></i>My Saved Trips</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-slate-100"><i data-lucide="x" class="h-5 w-5 text-slate-500"></i></button>
                </div>
                <div id="myTripsList" class="p-6 overflow-y-auto"></div>
            </div>
        </div>
        <div id="profileModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 modal-backdrop opacity-0">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col modal-content scale-95 opacity-0">
                <div class="flex justify-between items-center p-4 border-b border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="user-circle" class="text-cyan-500"></i> Your Profile
                    </h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-slate-100">
                        <i data-lucide="x" class="h-5 w-5 text-slate-500"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="profile-view">
                        <div class="space-y-4">
                             <div class="flex justify-center">
                                 <img id="profileImageView" class="h-24 w-24 rounded-full" src="" alt="Profile Picture">
                             </div>
                             <div>
                                 <p class="text-sm font-medium text-slate-500">Name</p>
                                 <p id="profileNameView" class="text-lg text-slate-800"></p>
                             </div>
                             <div>
                                 <p class="text-sm font-medium text-slate-500">Email</p>
                                 <p id="profileEmailView" class="text-lg text-slate-800"></p>
                             </div>
                             <button id="editProfileBtn" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 px-6 rounded-lg">Edit Profile</button>
                        </div>
                    </div>
                    <div id="profile-edit" class="hidden">
                        <form id="profileEditForm" class="space-y-4">
                            <div>
                                <label for="profileNameEdit" class="block text-sm font-medium text-slate-700">Your Name</label>
                                <input type="text" id="profileNameEdit" class="mt-1 w-full py-2 px-3 border border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <div class="flex items-center gap-4">
                               <button type="button" id="cancelEditProfileBtn" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 px-6 rounded-lg">Cancel</button>
                               <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2.5 px-6 rounded-lg">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div id="travelCostModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 modal-backdrop opacity-0">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col modal-content scale-95 opacity-0">
                <div class="flex justify-between items-center p-4 border-b border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="plane" class="text-cyan-500"></i> Estimate Travel Cost
                    </h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-slate-100">
                        <i data-lucide="x" class="h-5 w-5 text-slate-500"></i>
                    </button>
                </div>
                <div class="p-6">
                    <p class="text-slate-600 mb-4">Enter your starting location to estimate travel costs to your destination.</p>
                    <form id="travelCostForm" class="space-y-4">
                        <div>
                            <label for="travelFrom" class="block text-sm font-medium text-slate-700">Starting Location (City, Country)</label>
                            <div class="mt-1 relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="map-pin" class="h-5 w-5 text-slate-400"></i>
                                </div>
                                <input type="text" id="travelFrom" class="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., Delhi, India">
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="button" id="cancelTravelCostBtn" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 px-6 rounded-lg">Cancel</button>
                            <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2.5 px-6 rounded-lg">Calculate</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-2">
        <p id="toastMessage"></p>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentItineraryData = null;
        let map = null;
        let markers = {};
        let blueIcon, redIcon;

        function initializeAppLogic() {
            // --- ELEMENTS ---
            const heroSection = document.getElementById('heroSection');
            const planningSection = document.getElementById('planningSection');
            const loadingSection = document.getElementById('loadingSection');
            const itinerarySection = document.getElementById('itinerarySection');
            const itineraryContentContainer = document.getElementById('itinerary-content-container');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            let toastTimeout;

            const startPlanningBtn = document.getElementById('startPlanningBtn');
            const startOverBtn = document.getElementById('startOverBtn');
            const generateBtn = document.getElementById('generateBtn');
            const loaderText = document.getElementById('loaderText');
            const saveTripBtn = document.getElementById('saveTripBtn');
            const authContainerButtons = document.getElementById('auth-container-buttons');
            const estimateTravelCostBtn = document.getElementById('estimateTravelCostBtn');
            const travelCostResult = document.getElementById('travelCostResult');
            
            const modalsContainer = document.getElementById('modals-container');
            const myTripsModal = document.getElementById('myTripsModal');
            const myTripsList = document.getElementById('myTripsList');
            const profileModal = document.getElementById('profileModal');
            const travelCostModal = document.getElementById('travelCostModal');
            const travelCostForm = document.getElementById('travelCostForm');
            const cancelTravelCostBtn = document.getElementById('cancelTravelCostBtn');

            const profileView = document.getElementById('profile-view');
            const profileEdit = document.getElementById('profile-edit');
            const editProfileBtn = document.getElementById('editProfileBtn');
            const cancelEditProfileBtn = document.getElementById('cancelEditProfileBtn');
            const profileEditForm = document.getElementById('profileEditForm');

            // --- MAP ICONS ---
            const createSVGIcon = (color) => L.divIcon({
                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="${color}" stroke="#fff" stroke-width="1"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
                className: 'custom-map-icon',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            blueIcon = createSVGIcon("#06b6d4");
            redIcon = createSVGIcon("#ef4444");

            // --- UI LOGIC ---
            function showSection(section) {
                [heroSection, planningSection, loadingSection, itinerarySection].forEach(s => s.classList.add('hidden'));
                errorMessage.classList.remove('show');
                section.classList.remove('hidden');
                window.scrollTo(0, 0);
            }
            
            function showToast(message) {
                toastMessage.textContent = message;
                toast.classList.add('show');
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3500);
            }

            function showError(message) {
                errorText.textContent = message || "Could not generate the itinerary. Please try again.";
                errorMessage.classList.add('show');
                showSection(planningSection);
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i data-lucide="sparkles"></i><span>Generate Itinerary</span>';
                lucide.createIcons();
            }
            
            function showModal(modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function closeModal(modal) {
                if (!modal) return;
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
            
            // FIX: UPDATED AUTH UI FUNCTION FOR MOBILE RELIABILITY
            function updateAuthUI() {
                const user = auth.getCurrentUser();
                authContainerButtons.innerHTML = ''; // Clear the container

                if (user) {
                    authContainerButtons.innerHTML = `
                        <button id="headerMyTripsBtn" class="inline-flex items-center space-x-2 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-cyan-600 transition-colors rounded-lg">
                            <i data-lucide="briefcase"></i>
                            <span class="hidden md:inline">My Trips</span>
                        </button>
                        <button id="headerProfileBtn" class="flex-shrink-0 p-2 rounded-full hover:bg-slate-100 transition-colors">
                            <img src="${user.picture}" alt="Profile" class="h-8 w-8 rounded-full">
                        </button>
                        <button id="logoutBtn" class="inline-flex items-center space-x-2 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-cyan-600 transition-colors rounded-lg">
                            <i data-lucide="log-out"></i>
                            <span class="hidden md:inline">Logout</span>
                        </button>
                    `;
                    document.getElementById('headerMyTripsBtn').addEventListener('click', loadAndShowTrips);
                    document.getElementById('headerProfileBtn').addEventListener('click', openProfileModal);
                    document.getElementById('logoutBtn').addEventListener('click', () => auth.logout());
                } else {
                    // Render the button explicitly into our container.
                    google.accounts.id.renderButton(
                        authContainerButtons,
                        { theme: "outline", size: "large", text: "signin_with", shape: "pill" }  
                    );
                }
                lucide.createIcons();
            }
            
            // --- API & DATA LOGIC ---
            function startGeneration() {
                 errorMessage.classList.remove('show');
                showSection(loadingSection);
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div><span>Generating...</span>';
                
                const destinationCity = document.getElementById('destination').value.split(',')[0] || "your destination";
                const loaderMessages = [ `Mapping your route across ${destinationCity}...`, "Optimizing your daily route...", "Finding hidden gems...", "Connecting the dots on your adventure..." ];
                let msgIndex = 0;
                loaderText.textContent = loaderMessages[0];
                const interval = setInterval(() => { msgIndex = (msgIndex + 1) % loaderMessages.length; loaderText.textContent = loaderMessages[msgIndex]; }, 2500);

                generateItinerary()
                    .then(itineraryData => {
                        clearInterval(interval);
                        if (itineraryData && itineraryData.days) {
                           renderItinerary(itineraryData);
                           showSection(itinerarySection);
                           setTimeout(() => { if (map) map.invalidateSize() }, 100);
                        } else { throw new Error("Invalid itinerary format received from AI."); }
                    })
                    .catch(err => { clearInterval(interval); console.error(err); showError(err.message); })
                    .finally(() => { generateBtn.disabled = false; generateBtn.innerHTML = '<i data-lucide="sparkles"></i><span>Generate Itinerary</span>'; lucide.createIcons(); });
            }

            async function generateItinerary() {
                const destination = document.getElementById('destination').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const travelers = document.getElementById('travelers').value;
                const budget = document.getElementById('budget').value;
                
                if (!destination || !startDate || !endDate || !travelers || !budget) { throw new Error("Please fill out all the trip details before generating."); }
                if (new Date(endDate) < new Date(startDate)) { throw new Error("End date cannot be before the start date."); }
                
                const tripLength = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                const schema = { type: "OBJECT", properties: { "days": { type: "ARRAY", items: { type: "OBJECT", properties: { "day": { type: "NUMBER" }, "title": { type: "STRING" }, "events": { type: "ARRAY", items: { type: "OBJECT", properties: { "time": { type: "STRING" }, "title": { type: "STRING" }, "locationName": { type: "STRING" }, "description": { type: "STRING" }, "cost": { type: "NUMBER" }, "icon": { type: "STRING" }, "latitude": { type: "NUMBER" }, "longitude": { type: "NUMBER" } }, required: ["time", "title", "locationName", "description", "cost", "icon", "latitude", "longitude"] } } }, required: ["day", "title", "events"] } }, "hotelRecommendations": { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "style": { "type": "STRING" }, "estimatedPricePerNight": { "type": "NUMBER" }, "description": { "type": "STRING" }, "latitude": { "type": "NUMBER" }, "longitude": { "type": "NUMBER" } }, required: ["name", "style", "estimatedPricePerNight", "description", "latitude", "longitude"] } }, "restaurantRecommendations": { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "cuisine": { "type": "STRING" }, "estimatedPricePerPerson": { "type": "NUMBER" }, "description": { "type": "STRING" }, "latitude": { "type": "NUMBER" }, "longitude": { "type": "NUMBER" } }, required: ["name", "cuisine", "estimatedPricePerPerson", "description", "latitude", "longitude"] } }, "budgetBreakdown": { type: "OBJECT", properties: { "accommodation": { "type": "NUMBER" }, "food": { "type": "NUMBER" }, "activities": { "type": "NUMBER" }, "localTravel": { "type": "NUMBER" }, "miscellaneous": { "type": "NUMBER" } }, required: ["accommodation", "food", "activities", "localTravel", "miscellaneous"] } }, required: ["days", "hotelRecommendations", "restaurantRecommendations", "budgetBreakdown"] };
                const validIcons = ["map-pin", "camera", "soup", "leaf", "shopping-cart", "trees", "beer", "gamepad-2", "heart", "gem", "bar-chart-2", "plane", "bus", "train", "utensils-crossed", "landmark", "mountain", "palace", "ticket", "log-in", "bed-double"];
                const systemPrompt = `You are an expert Travel Planner. Your task is to create a budget-friendly and logically sequenced itinerary based on user inputs, adhering strictly to the JSON schema. Key Constraints: 1.  **Strict Budget Adherence:** The sum of 'accommodation', 'food', 'activities', and 'localTravel' in the 'budgetBreakdown' MUST be less than or equal to the user's total budget. 'miscellaneous' is the remaining buffer. The sum of all five breakdown categories MUST precisely equal the total budget. 2.  **Geographical Optimization:** For each day, the 'events' MUST be ordered in a geographically logical sequence to create a sensible route that minimizes travel time and cost. 3.  **Realistic Planning:** Create a balanced plan that utilizes a significant portion of the budget for a good experience. Estimate a daily cost for local transport (metros, buses, etc.) and include the total in 'localTravel'. 4.  **Complete Data:** For every event and recommendation, you MUST provide a specific location name and its precise, real-world latitude and longitude coordinates. 5.  **Icon Selection:** For each daily event, choose the most appropriate icon from this list: ${validIcons.join(', ')}.`;
                const userQuery = `Generate a ${tripLength}-day travel itinerary for a trip to ${destination}. \n- Travelers: ${travelers} \n- Total Budget: â‚¹${budget} INR \n- Start Date: ${new Date(startDate).toDateString()} \n- End Date: ${new Date(endDate).toDateString()}. \nFocus on famous, iconic, and must-visit locations suitable for a student traveler. Include cultural sites, landmarks, and fun activities. Provide 3 budget-friendly hotel/hostel recommendations and 4 diverse, affordable food recommendations.`;
                return callGenerativeAPI(userQuery, systemPrompt, schema);
            }
            
          async function callGenerativeAPI(userQuery, systemPrompt, schema) {
            // NOTICE: The 'apiKey' variable is GONE. This file is now safe to be public.

            // This new URL is a special path that points to your new function
            // at /netlify/functions/call-gemini.js
            const apiUrl = "/.netlify/functions/call-gemini"; 
            
            // Package up the *entire* payload that the Google API needs
            const payload = { 
                contents: [{ parts: [{ text: userQuery }] }], 
                systemInstruction: { parts: [{ text: systemPrompt }] }, 
                generationConfig: { responseMimeType: "application/json", responseSchema: schema }, 
            };
            
            let response; let retries = 3; let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    // We send our payload to our *middleman* function, not Google
                    response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        // The payload is sent in the body
                        body: JSON.stringify(payload) 
                    });
                    
                    if (response.ok) {
                        // The response comes back from our middleman
                        const result = await response.json(); 
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (jsonText) { 
                            return JSON.parse(jsonText); 
                        } else { 
                            // This catches errors from the Google API itself
                            // (e.g., if the prompt was blocked for safety)
                            console.error("API Error Response:", result);
                            throw new Error(result?.error?.message || "API returned an empty or invalid response.");
                        }
                    } else {
                        // This catches errors from the middleman function
                        // (e.g., if the function crashed)
                        if (response.status === 429 || response.status >= 500) { 
                            await new Promise(res => setTimeout(res, delay)); 
                            delay *= 2; 
                            continue; 
                        }
                        const errorBody = await response.json();
                        throw new Error(`API request failed with status: ${response.status}. ${errorBody?.error?.message || ''}`);
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                    if (i === retries - 1) throw error; // Throw after last retry
                    await new Promise(res => setTimeout(res, delay)); 
                    delay *= 2;
                }
            }
        }
            function recalculateAndUpdateBudget() {
                if (!currentItineraryData) return;
                const totalBudget = parseFloat(currentItineraryData.details.budget);
                let estimatedCost = 0;
                if (currentItineraryData.budgetBreakdown) {
                    const breakdown = currentItineraryData.budgetBreakdown;
                    estimatedCost = breakdown.accommodation + breakdown.food + breakdown.activities + breakdown.localTravel;
                }
                document.getElementById('estimated-cost').textContent = `â‚¹${estimatedCost.toFixed(0)}`;
                const budgetPercentage = totalBudget > 0 ? Math.min((estimatedCost / totalBudget) * 100, 100) : 0;
                document.getElementById('budget-bar').style.width = `${budgetPercentage}%`;
            }

            function renderItinerary(itineraryData, tripDetails = null) {
                const details = tripDetails || {
                    destination: document.getElementById('destination').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    budget: document.getElementById('budget').value,
                };
                currentItineraryData = { ...itineraryData, details };
                const startDate = new Date(details.startDate);
                const endDate = new Date(details.endDate);
                const destination = details.destination.split(',')[0];
                const formatDate = (date) => new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).format(date);
                
                document.getElementById('trip-location').textContent = `Your Trip to ${destination}`;
                document.getElementById('trip-dates').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                document.getElementById('total-budget').textContent = `â‚¹${parseFloat(details.budget).toFixed(0)}`;
                travelCostResult.innerHTML = '';

                recalculateAndUpdateBudget();
                
                if (itineraryData.budgetBreakdown) {
                    document.getElementById('budget-accommodation').textContent = `â‚¹${itineraryData.budgetBreakdown.accommodation.toFixed(0)}`;
                    document.getElementById('budget-food').textContent = `â‚¹${itineraryData.budgetBreakdown.food.toFixed(0)}`;
                    document.getElementById('budget-activities').textContent = `â‚¹${itineraryData.budgetBreakdown.activities.toFixed(0)}`;
                    document.getElementById('budget-travel').textContent = `â‚¹${itineraryData.budgetBreakdown.localTravel.toFixed(0)}`;
                    document.getElementById('budget-misc').textContent = `â‚¹${itineraryData.budgetBreakdown.miscellaneous.toFixed(0)}`;
                }

                const hotelCardsContainer = document.getElementById('hotel-cards');
                const restaurantCardsContainer = document.getElementById('restaurant-cards');
                hotelCardsContainer.innerHTML = '';
                restaurantCardsContainer.innerHTML = '';

                (itineraryData.hotelRecommendations || []).forEach(hotel => {  
                    const card = document.createElement('div');  
                    card.className = "bg-white p-3 rounded-lg border border-slate-200";  
                    card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-slate-800 text-sm">${hotel.name}</p><p class="text-xs text-slate-500">${hotel.style}</p></div><p class="text-sm font-semibold text-slate-700 bg-slate-100 px-2 py-1 rounded-md">â‚¹${hotel.estimatedPricePerNight}/night</p></div><p class="mt-2 text-slate-600 text-xs">${hotel.description}</p><div class="mt-2"><button data-lat="${hotel.latitude}" data-lon="${hotel.longitude}" class="focus-map-btn text-xs font-semibold text-cyan-600 hover:text-cyan-700 inline-flex items-center gap-1">Show on Map <i data-lucide="map-pin" class="h-3 w-3"></i></button></div>`;  
                    hotelCardsContainer.appendChild(card);  
                });
                (itineraryData.restaurantRecommendations || []).forEach(resto => {  
                    const card = document.createElement('div');  
                    card.className = "bg-white p-3 rounded-lg border border-slate-200";  
                    card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-slate-800 text-sm">${resto.name}</p><p class="text-xs text-slate-500">${resto.cuisine}</p></div><p class="text-sm font-semibold text-slate-700 bg-slate-100 px-2 py-1 rounded-md">~â‚¹${resto.estimatedPricePerPerson}/person</p></div><p class="mt-2 text-slate-600 text-xs">${resto.description}</p><div class="mt-2"><button data-lat="${resto.latitude}" data-lon="${resto.longitude}" class="focus-map-btn text-xs font-semibold text-cyan-600 hover:text-cyan-700 inline-flex items-center gap-1">Show on Map <i data-lucide="map-pin" class="h-3 w-3"></i></button></div>`;  
                    restaurantCardsContainer.appendChild(card);  
                });
                
                itineraryContentContainer.innerHTML = '';
                itineraryData.days.forEach((day, dayIndex) => {  
                    const dayContainer = document.createElement('div');  
                    dayContainer.className = "bg-white p-4 sm:p-6 rounded-xl shadow-md border border-slate-200";  
                    let contentHTML = `<div class="flex justify-between items-center mb-4"><h4 class="text-xl font-bold text-slate-800">Day ${day.day}: ${day.title}</h4></div><div class="space-y-4 day-events-container" data-day-index="${dayIndex}">`;  
                    (day.events || []).forEach((event, eventIndex) => {  
                        contentHTML += `<div class="event-card flex items-start space-x-4 draggable" data-id="${dayIndex}-${eventIndex}"><div class="flex-shrink-0 mt-1 flex flex-col items-center cursor-grab"><i data-lucide="grip-vertical" class="h-5 w-5 text-slate-400"></i></div><div class="flex-shrink-0 flex flex-col items-center"><div class="flex items-center justify-center h-10 w-10 rounded-full bg-slate-100 text-cyan-600"><i data-lucide="${event.icon}" class="h-5 w-5"></i></div></div><div class="bg-slate-50/50 p-4 rounded-lg border border-slate-200 w-full"><div class="flex justify-between items-start"><div><p class="font-semibold text-slate-500 text-sm">${event.time}</p><p class="font-bold text-slate-800">${event.title}</p><p class="text-xs text-slate-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="h-3 w-3"></i> ${event.locationName}</p></div><div class="flex items-center gap-2"><p class="text-sm font-semibold text-slate-700 bg-slate-200 px-2 py-1 rounded-md">â‚¹${event.cost || 0}</p></div></div><p class="mt-2 text-slate-600 text-sm">${event.description}</p><div class="mt-2"><button data-lat="${event.latitude}" data-lon="${event.longitude}" class="focus-map-btn text-xs font-semibold text-cyan-600 hover:text-cyan-700 inline-flex items-center gap-1">Show on Map <i data-lucide="map-pin" class="h-3 w-3"></i></button></div></div></div>`;  
                    });  
                    contentHTML += `</div>`;  
                    dayContainer.innerHTML = contentHTML;  
                    itineraryContentContainer.appendChild(dayContainer);  
                });
                setupMap(itineraryData);
                initializeSortable();
                lucide.createIcons();
            }

            function setupMap(itineraryData) {
                if (map) { map.remove(); map = null; }
                markers = {};
                const geoapifyApiKey = "5ca709090953414b81a9fcc9fb05de70";
                const allPoints = [];
                itineraryData.days.forEach(day => day.events.forEach(event => allPoints.push({ lat: event.latitude, lon: event.longitude, title: event.title, desc: `Day ${day.day}: ${event.time}` })));
                (itineraryData.hotelRecommendations || []).forEach(h => allPoints.push({ lat: h.latitude, lon: h.longitude, title: h.name, desc: 'Accommodation' }));
                (itineraryData.restaurantRecommendations || []).forEach(r => allPoints.push({ lat: r.latitude, lon: r.longitude, title: r.name, desc: 'Restaurant' }));
                if (allPoints.length === 0) { document.getElementById('map').innerHTML = `<div class="h-full w-full flex items-center justify-center text-slate-500">No locations to display</div>`; return; }
                map = L.map('map').setView([allPoints[0].lat, allPoints[0].lon], 13);
                L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png?apiKey=${geoapifyApiKey}`, { attribution: 'Powered by <a href="https://www.geoapify.com/" target="_blank">Geoapify</a>', maxZoom: 20, id: 'osm-bright' }).addTo(map);
                const markerGroup = L.featureGroup();
                allPoints.forEach(point => {
                    if (typeof point.lat === 'number' && typeof point.lon === 'number' && !isNaN(point.lat) && !isNaN(point.lon)) {
                        const marker = L.marker([point.lat, point.lon], { icon: blueIcon });
                        marker.bindPopup(`<b>${point.title}</b><br>${point.desc}`);
                        const markerKey = `${point.lat},${point.lon}`;
                        markers[markerKey] = marker;
                        markerGroup.addLayer(marker);
                    } else { console.warn("Skipping a location due to invalid coordinates:", point); }
                });
                if (markerGroup.getLayers().length > 0) {
                    map.addLayer(markerGroup);
                    map.fitBounds(markerGroup.getBounds().pad(0.1));
                } else { document.getElementById('map').innerHTML = `<div class="h-full w-full flex items-center justify-center text-slate-500">Could not plot locations.</div>`; }
                document.querySelectorAll('.focus-map-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lat = e.currentTarget.dataset.lat;
                        const lon = e.currentTarget.dataset.lon;
                        Object.values(markers).forEach(m => m.setIcon(blueIcon));
                        const targetMarker = markers[`${lat},${lon}`];
                        if (targetMarker) { targetMarker.setIcon(redIcon); }
                        if (map) { map.flyTo([lat, lon], 16, { duration: 1.2 }); }
                    });
                });
            }
            
            const auth = {
                getUsers: () => JSON.parse(localStorage.getItem('wanderGenieUserData') || '{}'),
                saveUsers: (users) => localStorage.setItem('wanderGenieUserData', JSON.stringify(users)),
                getCurrentUser: () => JSON.parse(sessionStorage.getItem('wanderGenieCurrentUser')),
                setCurrentUser: (user) => {
                    const users = auth.getUsers();
                    if (!users[user.email]) {
                        users[user.email] = { name: user.name, trips: [] };
                        auth.saveUsers(users);
                    }
                    sessionStorage.setItem('wanderGenieCurrentUser', JSON.stringify(user));
                },
                clearCurrentUser: () => sessionStorage.removeItem('wanderGenieCurrentUser'),
                logout: () => {
                    auth.clearCurrentUser();
                    updateAuthUI();
                    showSection(heroSection);
                    showToast("You've been logged out.");
                },
                updateProfile: (newName) => {
                    const currentUser = auth.getCurrentUser();
                    if (!currentUser) return { success: false, message: "Not logged in." };
                    const users = auth.getUsers();
                    if (users[currentUser.email]) {
                        users[currentUser.email].name = newName;
                        auth.saveUsers(users);
                        const updatedUser = { ...currentUser, name: newName };
                        auth.setCurrentUser(updatedUser);
                        return { success: true };
                    }
                    return { success: false, message: "Could not find user to update."};
                }
            };
            
            const userData = {
                 getTrips: () => {
                    const currentUser = auth.getCurrentUser();
                    if (!currentUser) return [];
                    const users = auth.getUsers();
                    return users[currentUser.email]?.trips || [];
                 },
                 saveTrips: (trips) => {
                    const currentUser = auth.getCurrentUser();
                    if (!currentUser) return;
                    const users = auth.getUsers();
                    if (users[currentUser.email]) {
                        users[currentUser.email].trips = trips;
                        auth.saveUsers(users);
                    }
                 }
            };

            function saveCurrentTrip() {
                if (!auth.getCurrentUser()) {
                    showToast("Please login to save trips.");
                    google.accounts.id.prompt();
                    return;
                }
                if (!currentItineraryData) {
                    showToast("No active itinerary to save.");
                    return;
                }
                const trips = userData.getTrips();
                const newTrip = { id: Date.now(), ...currentItineraryData };
                trips.unshift(newTrip);
                userData.saveTrips(trips);
                showToast("Trip saved successfully!");
            }

            function loadAndShowTrips() {
                if (!auth.getCurrentUser()) {
                    showToast("Please login to view your trips.");
                    google.accounts.id.prompt();
                    return;
                }
                const trips = userData.getTrips();
                myTripsList.innerHTML = '';
                if (trips.length === 0) {
                    myTripsList.innerHTML = `<p class="text-slate-500 text-center">You have no saved trips yet.</p>`;
                } else {
                    const list = document.createElement('div');
                    list.className = 'space-y-4';
                    trips.forEach(trip => {
                        const item = document.createElement('div');
                        item.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-center';
                        const destination = trip.details.destination;
                        const startDate = new Date(trip.details.startDate);
                        const formatDate = (date) => new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' }).format(date);
                        item.innerHTML = `<div><p class="font-bold text-slate-800">${destination}</p><p class="text-sm text-slate-500">${formatDate(startDate)}</p></div><div class="flex items-center gap-2"><button data-trip-id="${trip.id}" class="load-trip-btn bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm">Load</button><button data-trip-id="${trip.id}" class="delete-trip-btn p-2 rounded-md hover:bg-red-100 text-red-500"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`;
                        list.appendChild(item);
                    });
                    myTripsList.appendChild(list);
                    lucide.createIcons();
                }
                showModal(myTripsModal);
            }
            
            function handleMyTripsListClick(e) {
                const loadBtn = e.target.closest('.load-trip-btn');
                const deleteBtn = e.target.closest('.delete-trip-btn');
                if (loadBtn) {
                    const tripId = Number(loadBtn.dataset.tripId);
                    const tripToLoad = userData.getTrips().find(t => t.id === tripId);
                    if (tripToLoad) {
                        renderItinerary(tripToLoad, tripToLoad.details);
                        showSection(itinerarySection);
                        closeModal(myTripsModal);
                        setTimeout(() => { if (map) map.invalidateSize() }, 100);
                    }
                }
                if (deleteBtn) {
                    let trips = userData.getTrips().filter(t => t.id !== Number(deleteBtn.dataset.tripId));
                    userData.saveTrips(trips);
                    loadAndShowTrips();
                }
            }
            
            function openProfileModal() {
                const user = auth.getCurrentUser();
                if (!user) return;
                document.getElementById('profileImageView').src = user.picture;
                document.getElementById('profileNameView').textContent = user.name;
                document.getElementById('profileEmailView').textContent = user.email;
                document.getElementById('profileNameEdit').value = user.name;
                profileView.classList.remove('hidden');
                profileEdit.classList.add('hidden');
                showModal(profileModal);
            }
            
            function decodeJwtResponse(token) {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            }

            window.handleGoogleSignIn = (response) => {
                const responsePayload = decodeJwtResponse(response.credential);
                const user = { email: responsePayload.email, name: responsePayload.name, picture: responsePayload.picture };
                auth.setCurrentUser(user);
                updateAuthUI();
                showToast(`Welcome, ${user.name}!`);
            };

            function openTravelCostModal() {
                showModal(travelCostModal);
                document.getElementById('travelFrom').focus();
            }

            function handleTravelCostEstimation(e) {
                e.preventDefault();
                const travelFrom = document.getElementById('travelFrom').value.trim();
                if (!travelFrom) { showToast("Please enter your starting location."); return; }
                if (!currentItineraryData?.days[0]?.events[0]) { showToast("Destination location not available."); return; }
                const submitBtn = travelCostForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mx-auto"></div>';
                submitBtn.disabled = true;
                setTimeout(() => {
                    const { latitude: destLat, longitude: destLon } = currentItineraryData.days[0].events[0];
                    const startLat = destLat + (Math.random() * 10 - 5);
                    const startLon = destLon + (Math.random() * 10 - 5);
                    const distance = getHaversineDistance(startLat, startLon, destLat, destLon);
                    const flightCost = Math.max(2000, distance * 8);
                    const trainCost = Math.max(500, distance * 2);
                    const busCost = Math.max(300, distance * 1.5);
                    travelCostResult.innerHTML = `<div class="bg-slate-50 p-4 rounded-lg border border-slate-200"><h4 class="font-bold text-slate-800 mb-2">Travel Cost from ${travelFrom}</h4><div class="space-y-2 text-sm"><div class="flex justify-between"><span>Flight (round trip):</span><span class="font-semibold">â‚¹${flightCost.toFixed(0)}</span></div><div class="flex justify-between"><span>Train (round trip):</span><span class="font-semibold">â‚¹${trainCost.toFixed(0)}</span></div><div class="flex justify-between"><span>Bus (round trip):</span><span class="font-semibold">â‚¹${busCost.toFixed(0)}</span></div></div><p class="text-xs text-slate-500 mt-3">Based on approximate distance of ${distance.toFixed(0)} km. Prices are estimates for planning purposes.</p></div>`;
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    closeModal(travelCostModal);
                }, 1500);
            }

            function getHaversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            startPlanningBtn.addEventListener('click', () => {
                if (auth.getCurrentUser()) {
                    showSection(planningSection);
                } else {
                    showToast("Please sign in to plan a new trip.");
                    google.accounts.id.prompt();
                }
            });
            generateBtn.addEventListener('click', startGeneration);
            startOverBtn.addEventListener('click', () => { if (map) { map.remove(); map = null; }; showSection(heroSection); });
            saveTripBtn.addEventListener('click', saveCurrentTrip);
            estimateTravelCostBtn.addEventListener('click', openTravelCostModal);
            travelCostForm.addEventListener('submit', handleTravelCostEstimation);
            cancelTravelCostBtn.addEventListener('click', () => closeModal(travelCostModal));
            
            // --- FIX: SORTABLEJS IMPLEMENTATION FOR DRAG-AND-DROP ---
            function regenerateTimesForDay(events) {
                const timeSlots = ["09:00 AM", "10:30 AM", "12:00 PM", "01:30 PM", "03:00 PM", "04:30 PM", "06:00 PM", "07:30 PM", "09:00 PM", "10:00 PM"];
                events.forEach((event, index) => {
                    if (index < timeSlots.length) event.time = timeSlots[index];
                });
            }

            function initializeSortable() {
                document.querySelectorAll('.day-events-container').forEach(container => {
                    if (container.sortable) container.sortable.destroy();
                    
                    container.sortable = new Sortable(container, {
                        animation: 150,
                        draggable: '.draggable',
                        handle: '.draggable', // Makes the whole card draggable
                        onEnd: (evt) => {
                            const { oldIndex, newIndex } = evt;
                            const dayIndex = parseInt(container.dataset.dayIndex);
                            const dayEvents = currentItineraryData.days[dayIndex].events;
                            
                            // Re-order the data array to match the DOM
                            const [movedItem] = dayEvents.splice(oldIndex, 1);
                            dayEvents.splice(newIndex, 0, movedItem);
                            
                            // Update times and re-render to ensure data and UI are in sync
                            regenerateTimesForDay(dayEvents);
                            renderItinerary(currentItineraryData, currentItineraryData.details);
                            showToast("Itinerary order updated!");
                        },
                    });
                });
            }

            modalsContainer.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal-backdrop');
                if (e.target.closest('.close-modal-btn') || e.target === modal) {
                    closeModal(modal);
                }
            });
            myTripsList.addEventListener('click', handleMyTripsListClick);

            editProfileBtn.addEventListener('click', () => {
                profileView.classList.add('hidden');
                profileEdit.classList.remove('hidden');
            });
            cancelEditProfileBtn.addEventListener('click', () => {
                profileView.classList.remove('hidden');
                profileEdit.classList.add('hidden');
            });
            profileEditForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = document.getElementById('profileNameEdit').value.trim();
                if (newName) {
                    const result = auth.updateProfile(newName);
                    if (result.success) {
                        showToast("Profile updated successfully!");
                        closeModal(profileModal);
                        updateAuthUI(); // Refresh UI to show new name if needed
                    } else {
                        showToast(result.message);
                    }
                }
            });
            
            // --- INITIALIZATION ---
            window.onload = function () {
                lucide.createIcons();
                updateAuthUI();
                
                const todayStr = new Date().toISOString().split('T')[0];
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                startDateInput.setAttribute('min', todayStr);
                startDateInput.addEventListener('change', (e) => {
                    endDateInput.value = '';
                    endDateInput.setAttribute('min', e.target.value);
                });
            }
        }
        
        initializeAppLogic();
    </script>
</body>
</html>